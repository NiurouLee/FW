FormulaKeyWord = {
    ["公式000 最终攻击力"] = "FinalAtk",
    ["公式000 最终防御力"] = "FinalDef",
    ["公式000 基础伤害值"] = "BaseDamage",
    ["公式000 最终伤害值"] = "FinalDamage",
    ["公式000 回血"] = "CalcAddBlood",
    ["公式001 普攻"] = "CalcDamage_1",
    ["公式002 怪物"] = "CalcDamage_2",
    ["公式003"] = "CalcDamage_3",
    ["公式004 连锁技"] = "CalcDamage_4",
    ["公式005 主动技"] = "CalcDamage_5",
    ["公式006"] = "CalcDamage_6",
    ["公式007"] = "CalcDamage_7",
    ["公式008"] = "CalcDamage_8",
    ["公式009"] = "CalcDamage_9",
    ["公式010"] = "CalcDamage_10",
    ["公式011"] = "CalcDamage_11",
    ["公式013 流血"] = "CalcDamage_13",
    ["公式014 灼烧"] = "CalcDamage_14",
    ["公式015 中毒"] = "CalcDamage_15",
    ["公式016 爆炸"] = "CalcDamage_16",
    ["公式017 即死"] = "CalcDamage_17",
    ["公式018 反伤"] = "CalcDamage_18",
    ["公式019"] = "CalcDamage_19",
    ["公式100"] = "CalcDamage_100",
    ["公式101"] = "CalcDamage_101",
    ["公式102"] = "CalcDamage_102",
    ["公式103"] = "CalcDamage_103",
    ["公式104"] = "CalcDamage_104",
    ["公式105"] = "CalcDamage_105",
    ["公式106"] = "CalcDamage_106",
    ["公式107"] = "CalcDamage_107",
    ["公式108"] = "CalcDamage_108",
    ["公式109"] = "CalcDamage_109",
    ["公式110"] = "CalcDamage_110",
    ["公式111"] = "CalcDamage_111",
    ["公式112"] = "CalcDamage_112",
    ["公式113"] = "CalcDamage_113",
    ["公式114"] = "CalcDamage_114",
    ["公式115"] = "CalcDamage_115",
    ["公式116"] = "CalcDamage_116",
    ["公式117"] = "CalcDamage_117",
    ["公式118"] = "CalcDamage_118",
    ["公式119"] = "CalcDamage_119",
    ["公式120"] = "CalcDamage_120",
    ["公式121"] = "CalcDamage_121",
    ["公式122"] = "CalcDamage_122",
    ["公式123"] = "CalcDamage_123",
    ["公式124"] = "CalcDamage_124",
    ["公式125"] = "CalcDamage_125",
    ["公式126"] = "CalcDamage_126",
    ["公式126"] = "CalcDamage_127",
    ["公式131"] = "CalcDamage_131",
    ["公式132"] = "CalcDamage_132",
    ["公式133"] = "CalcDamage_133",
    ["公式134"] = "CalcDamage_134",
    ["公式135"] = "CalcDamage_135",
    ["公式136"] = "CalcDamage_136",
    ["公式137"] = "CalcDamage_137",
    ["公式138"] = "CalcDamage_138",
    ["公式139"] = "CalcDamage_139",
    ["公式140"] = "CalcDamage_140",
    ["公式141"] = "CalcDamage_141",
    ["公式142"] = "CalcDamage_PoisonByAttack",
    ["公式143"] = "CalcDamage_AkxyCasterLayerToDamage",
    ["公式144"] = "CalcDamage_WeikeCompanionNormalAttack",
    ["公式145"] = "CalcDamage_145",
    ["公式146"] = "CalcDamage_RealDamageByLoseHP",
    ["公式147"] = "CalcDamage_AntiSetNoPercentDamage",
    ["公式148"] = "CalcDamage_AntiSetNoPercentDamageMaxHPPercent",
    ["公式149"] = "CalcDamage_ActiveAttackNoAbsorb",
    ["公式150"] = "CalcDamage_150",
}

FormulaAttrDict = {
    ["回血系数"] = "rate",
    ["基础攻击力"] = "attack",
    ["攻击百分比"] = "attackPercentage",
    ["攻击绝对值"] = "attackConstantFix",
    ["基础防御力"] = "defence",
    ["防御百分比"] = "defencePercentage",
    ["防御绝对值"] = "defenceConstantFix",
    ["最终攻击力"] = "finalAtk",
    ["最终防御力"] = "rawFinalDef",
    ["无视防御系数"] = "noDefence",
    ["最终增伤系数"] = "defenderFinal",
    ["基础伤害值"] = "baseDamage",
    ["技能伤害系数"] = "damagePercent",
    ["Combo系数"] = "comboParam",
    ["强化格子系数"] = "superGridParam",
    ["弱化格子系数"] = "poorGridParam",
    ["属性克制系数"] = "elementParam",
    ["主副属性系数"] = "primarySecondaryParam",
    ["暴击系数"] = "critParam",
    ["技能提升系数"] = "skillIncreaseParam",
    ["技能最终系数"] = "skillFinalParam",
    ["普攻连线系数"] = "normalChainParam",
    ["连锁连线系数"] = "chainChainParam",
    ["普攻吸收系数"] = "normalSkillAbsorbParam",
    ["连锁吸收系数"] = "chainSkillAbsorbParam",
    ["大招吸收系数"] = "activeSkillAbsorbParam",
    ["加血量"] = "blood",
    ["溅射系数"] = "splashRate",
    ["浮动系数"] = "floatRate",
    ["传导系数"] = "transPercent",
    ["层数"] = "layer",
    ["受单体攻击最终增伤系数"] = "dmgParamSingleTypeSkill",
    ["光灵作为队长时最终伤害增伤系数"] = "finalBehitByTeamLeaderDamageParam",
    ["灼烧加深"] = "increaseBurn",
    ["san技能最终伤害系数"] = "attackerSanFinal",
    ["光灵无视防御伤害提高系数"] = "petNoDefenceDamageIncreaseParam"
}

BaseAttrDict = {
    ["当前血量"] = "HP",
    ["血量上限"] = "MaxHP",
    ["基础攻击力"] = "Attack",
    ["基础防御力"] = "Defense",
    ["传说能量"] = "LegendPower",
    ["当前能量"] = "Power",
    ["能量上限"] = "MaxPower",
    ["大招就绪"] = "Ready",
    ["行动力"] = "Mobility",
    ["行动力上限"] = "MaxMobility",
    ["主副属性系数"] = "PrimarySecondaryParam",
    ["攻击加成百分比"] = "AttackPercentage",
    ["攻击加成绝对值"] = "AttackConstantFix",
    ["血量上限加成百分比"] = "MaxHPPercentage",
    ["血量上限加成固定值"] = "MaxHPConstantFix",
    ["防御加成百分比"] = "DefencePercentage",
    ["防御加成绝对值"] = "DefenceConstantFix",
    ["最终增伤系数"] = "FinalBehitDamageParam",
    ["额外暴击率"] = "AdditionalCritProb",
    ["回血加成系数"] = "AddBloodRate",
    ["普攻技能系数"] = "NormalSkillParam",
    ["连锁技能系数"] = "ChainSkillParam",
    ["主动技能系数"] = "ActiveSkillParam",
    ["怪物技能系数"] = "MonsterSkillParam",
    ["普攻技能提升系数"] = "NormalSkillIncreaseParam",
    ["连锁技能提升系数"] = "ChainSkillIncreaseParam",
    ["主动技能提升系数"] = "ActiveSkillIncreaseParam",
    ["怪物技能提升系数"] = "MonsterSkillIncreaseParam",
    ["机关技能提升系数"] = "TrapSkillIncreaseParam",
    ["普攻技能最终系数"] = "NormalSkillFinalParam",
    ["连锁技能最终系数"] = "ChainSkillFinalParam",
    ["主动技能最终系数"] = "ActiveSkillFinalParam",
    ["怪物技能最终系数"] = "MonsterSkillFinalParam",
    ["普攻吸收系数"] = "AbsorbNormal",
    ["连锁吸收系数"] = "AbsorbChain",
    ["大招吸收系数"] = "AbsorbActive",
    ["受敌方队长伤害增伤系数"] = "FinalBehitByTeamLeaderDamageParam",
    ["受敌方队员伤害增伤系数"] = "FinalBehitByTeamMemberDamageParam",
    ["队长更换次数"] = "ChangeTeamLeaderCount"
}

--捕获技能公式参数
_class("CaptureFormulaAttr_Test", AutoTestCheckPointBase)
CaptureFormulaAttr_Test = CaptureFormulaAttr_Test

function CaptureFormulaAttr_Test:BeforeCheck()
end

function CaptureFormulaAttr_Test:Check(notify)
    local svc = self._world:GetService("AutoTest")
    local skillid = self._args.skillid
    local defender = svc:GetEntityByName_Test(self._args.defname)
    local key = self._args.key
    local attr = self._args.attr
    local varname = self._args.varname
    local damageIndex = self._args.damageIndex or 1

    local matchDefender = function(defenderid)
        if not defender or not defenderid then
            return true
        else
            return defender:GetID() == defenderid
        end
    end



    local index = 0
    local t = notify:GetMatchLogInfo()
    local curID = t.skillid
    if not curID then
        curID = t.buffid
    end
    if curID == skillid then
        if t.calcDamage then
            for i, v in ipairs(t.calcDamage) do
                for k, d in ipairs(v) do
                    if matchDefender(d.defender) and key == d.key then
                        index = index + 1
                        if index == damageIndex then
                            svc:WriteBlackBoard_Test(varname, d[attr])
                            self._message = " " .. attr .. "=" .. tostring(d[attr])
                            return true
                        end
                    end
                end
            end
        end
        if t.calcAddBlood then
            for i, d in ipairs(t.calcAddBlood) do
                if matchDefender(d.defender) and key == d.key and d[attr] then
                    svc:WriteBlackBoard_Test(varname, d[attr])
                    self._message = " " .. attr .. "=" .. tostring(d[attr])
                    return true
                end
            end
        end
    end
    return false
end

--检查技能公式参数
_class("CheckFormulaAttr_Test", AutoTestCheckPointBase)
CheckFormulaAttr_Test = CheckFormulaAttr_Test

function CheckFormulaAttr_Test:BeforeCheck()
end

function CheckFormulaAttr_Test:Check(notify)
    local svc = self._world:GetService("AutoTest")
    local skillid = self._args.skillid
    local defender = svc:GetEntityByName_Test(self._args.defname)
    local key = self._args.key
    local attr = self._args.attr
    local expect = self._args.expect

    local matchDefender = function(defenderid)
        if not defender or not defenderid then
            return true
        else
            return defender:GetID() == defenderid
        end
    end

    local t = notify:GetMatchLogInfo()
    if t.skillid == skillid then
        if t.calcDamage then
            for i, v in ipairs(t.calcDamage) do
                for k, d in ipairs(v) do
                    if matchDefender(d.defender) and key == d.key and d[attr] then
                        self._message = " " .. attr .. "=" .. tostring(d[attr])
                        if math.abs(expect - d[attr]) < 0.001 then
                            return true
                        end
                    end
                end
            end
        end
        if t.calcAddBlood then
            for i, d in ipairs(t.calcAddBlood) do
                if matchDefender(d.defender) and key == d.key and d[attr] then
                    self._message = " " .. attr .. "=" .. tostring(d[attr])
                    if math.abs(expect - d[attr]) < 0.001 then
                        return true
                    end
                end
            end
        end
    end
    return false
end

--检查技能范围
_class("CheckSkillRange_Test", AutoTestCheckPointBase)
CheckSkillRange_Test = CheckSkillRange_Test

function CheckSkillRange_Test:BeforeCheck()
end

function CheckSkillRange_Test:Check(notify)
    local svc = self._world:GetService("AutoTest")
    local skillid = self._args.skillid
    local range = self._args.range
    table.sort(range)

    local poslist = {}
    local t = notify:GetMatchLogInfo()
    if t.skillid == skillid then
        for i, pos in ipairs(t.range) do
            poslist[#poslist + 1] = Vector2.Pos2Index(pos)
        end
        table.sort(poslist)

        self._message = " skillid=" ..
            skillid ..
            "\n\t range=[" .. table.concat(poslist, " ") .. "]\n\t expect=[" .. table.concat(range, " ") .. "]"
        for i = 1, #range do
            if (poslist[i] ~= range[i]) then
                return false
            end
        end
        return true
    end
    return false
end

--捕获伤害数值并存储[普攻、连锁、大招每次攻击后通知里带有伤害值]
_class("CaptureDamageValue_Test", AutoTestCheckPointBase)
CaptureDamageValue_Test = CaptureDamageValue_Test

function CaptureDamageValue_Test:BeforeCheck()
end

function CaptureDamageValue_Test:Check(notify)
    local defender = notify:GetDefenderEntity()
    local damage = notify:GetDamageValue()
    if self._entity == defender then
        local key = self._args.key
        local svc = self._world:GetService("AutoTest")
        svc:WriteBlackBoard_Test(key, damage)
        self._message = key .. "=" .. damage
        return true
    end
    return false
end

--捕获二次连锁伤害数值并存储【二次连锁通知里带有伤害值】
_class("CaptureDoubleChainDamageValue_Test", AutoTestCheckPointBase)
CaptureDoubleChainDamageValue_Test = CaptureDoubleChainDamageValue_Test

function CaptureDoubleChainDamageValue_Test:BeforeCheck()
end

function CaptureDoubleChainDamageValue_Test:Check(notify)
    local defender = notify:GetDefenderEntity()
    local damage = notify:GetDamageValue()
    local chainIdx = notify:GetChainSkillIndex()
    if self._entity == defender and chainIdx == 2 then
        local key = self._args.key
        local svc = self._world:GetService("AutoTest")
        svc:WriteBlackBoard_Test(key, damage)
        self._message = " " .. key .. "=" .. damage

        return true
    end
    return false
end

--检查目标属性值
_class("CheckEntityAttribute_Test", AutoTestCheckPointBase)
CheckEntityAttribute_Test = CheckEntityAttribute_Test

function CheckEntityAttribute_Test:BeforeCheck()
end

function CheckEntityAttribute_Test:Check(notify)
    local attrCmpt = self._entity:Attributes()
    local attr = self._args.attr
    local val = attrCmpt:GetAttribute(attr)
    local expect = self._args.expect

    self._message = " " .. attr .. "=" .. val .. " expect=" .. expect
    return math.abs(val - expect) < 0.001
end

--检查目标属性值变化
_class("CheckAttributeChange_Test", AutoTestCheckPointBase)
CheckAttributeChange_Test = CheckAttributeChange_Test

function CheckAttributeChange_Test:BeforeCheck()
    local attrCmpt = self._entity:Attributes()
    local attr = self._args.attr
    local val = attrCmpt:GetAttribute(attr) or 0
    self._oldVal = val
end

function CheckAttributeChange_Test:Check(notify)
    local attrCmpt = self._entity:Attributes()
    local attr = self._args.attr
    local val1 = self._oldVal
    local val2 = attrCmpt:GetAttribute(attr) or 0
    local cmp = self._args.cmp
    local f = CompareFuncMap[cmp]
    self._message = " " .. attr .. " old:" .. val1 .. " " .. cmp .. " new:" .. val2
    if f and f(val1, val2) then
        return true
    end
    return false
end

--检查捕获数值
_class("CheckLocalValue_Test", AutoTestCheckPointBase)
CheckLocalValue_Test = CheckLocalValue_Test
function CheckLocalValue_Test:BeforeCheck()
end

function CheckLocalValue_Test:Check(notify)
    local svc = self._world:GetService("AutoTest")
    local varname = self._args.varname
    local val = svc:ReadBlackBoard_Test(varname) or 0
    local targetVal = self._args.target

    self._message = " " .. varname .. "=" .. (val or "nil") .. "  expect " .. targetVal
    if math.abs(targetVal - val) < 0.0001 then
        return true
    end
    return false
end

--检查捕获数值（指定精度）
_class("CheckLocalValueWithPrecision_Test", AutoTestCheckPointBase)
CheckLocalValueWithPrecision_Test = CheckLocalValueWithPrecision_Test
function CheckLocalValueWithPrecision_Test:BeforeCheck()
end

function CheckLocalValueWithPrecision_Test:Check(notify)
    local svc = self._world:GetService("AutoTest")
    local varname = self._args.varname
    local val = svc:ReadBlackBoard_Test(varname) or 0
    local targetVal = self._args.target
    local precision = self._args.precision
    precision = tonumber(precision)
    precision = math.floor(precision)
    local precisionParam = 10 ^ precision
    self._message = " " .. varname .. "=" .. (val or "nil") .. "  expect " .. targetVal .. "  precision " .. precision
    local valWithPrecision = math.floor(val * precisionParam + 0.5)
    local targetValWithPrecision = math.floor(val * precisionParam + 0.5)
    if math.abs(valWithPrecision - targetValWithPrecision) < 1 then
        return true
    end
    return false
end

--检查数值关系
_class("CompareLocalValue_Test", AutoTestCheckPointBase)
CompareLocalValue_Test = CompareLocalValue_Test

function CompareLocalValue_Test:BeforeCheck()
end

function CompareLocalValue_Test:Check(notify)
    local svc = self._world:GetService("AutoTest")
    local key1 = self._args.key1
    local val1 = svc:ReadBlackBoard_Test(key1, 0)
    local key2 = self._args.key2
    local val2 = svc:ReadBlackBoard_Test(key2, 0)
    local cmp = self._args.cmp

    local f = CompareFuncMap[cmp]

    self._message = " " .. key1 .. ":" .. val1 .. " " .. cmp .. " " .. key2 .. ":" .. val2
    if f and f(val1, val2) then
        return true
    end
    return false
end

--比较数值与期望值的关系
_class("CompareLocalValueWithOperator_Test", AutoTestCheckPointBase)
CompareLocalValueWithOperator_Test = CompareLocalValueWithOperator_Test

function CompareLocalValueWithOperator_Test:BeforeCheck()
end

function CompareLocalValueWithOperator_Test:Check(notify)
    local svc = self._world:GetService("AutoTest")
    local key = self._args.key
    local val = svc:ReadBlackBoard_Test(key, 0)
    local cmp = self._args.cmp
    local expect = self._args.expect

    local f = CompareFuncMap[cmp]

    self._message = " " .. key .. ":" .. val .. " " .. cmp .. " 期望值:" .. expect
    if f and f(val, expect) then
        return true
    end
    return false
end
